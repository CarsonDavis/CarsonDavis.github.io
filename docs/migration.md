# Migration Guide (One-Time Setup)

This doc covers migrating from the old image system (manual WebP conversion, no LQIP) to the new one (automated Lambda pipeline with blur-to-sharp loading). Delete this file once migration is complete.

## What's Changing

| Before | After |
|--------|-------|
| Convert images locally with `cwebp` | Upload originals to S3, Lambda converts automatically |
| No placeholders — images pop in as they download | LQIP thumbnails load instantly, blur-to-sharp transition |
| `<img src="photo.webp">` | `<img src="lqip/photo.webp" data-full="webp/photo.webp" class="lqip" ...>` |
| Layout shift on image-heavy pages | `aspect-ratio` reserves space, zero CLS |

## Step 1: Deploy Lambda Infrastructure

### Prerequisites

- AWS CLI configured (`aws configure`)
- SAM CLI installed (`brew install aws-sam-cli`)
- Docker running

### Deploy

```bash
cd lambda

# Build (compiles Pillow for Lambda's Linux runtime)
make build

# Deploy to AWS (first time is interactive)
make deploy

# Wire S3 events to the Lambda (one-time)
make setup-trigger
```

### Verify

Upload a test image and confirm the Lambda processes it:

```bash
aws s3 cp test.jpg s3://made-by-carson-images/test-folder/original/test.jpg

# Wait a few seconds, then check
aws s3 ls s3://made-by-carson-images/test-folder/webp/test.webp
aws s3 ls s3://made-by-carson-images/test-folder/lqip/test.webp
```

Clean up the test folder:

```bash
aws s3 rm s3://made-by-carson-images/test-folder/ --recursive
```

## Step 2: Backfill LQIPs for Existing Images

The Lambda only processes new uploads. Existing images (~914 WebPs across all posts) need LQIP thumbnails generated by the backfill script.

```bash
# Set AWS credentials
export AWS_ACCESS_KEY_ID=...
export AWS_SECRET_ACCESS_KEY=...

# Preview what would be generated
uv run scripts/lqip_generator.py --dry-run

# Generate all missing LQIPs
uv run scripts/lqip_generator.py
```

To process a single folder:

```bash
uv run scripts/lqip_generator.py --folder film-camera-photos
```

## Step 3: Migrate Post Markdown

The migration script converts existing image tags to LQIP format. It handles both HTML `<img>` tags and Markdown `![alt](src)` images.

```bash
# Preview all changes (no files modified)
uv run scripts/migrate_to_lqip.py --dry-run --all

# Review the dry-run output carefully, then apply
uv run scripts/migrate_to_lqip.py --all
```

The script:
- Only processes posts with a `media_subpath` in frontmatter
- Skips images that are already migrated (have `data-full`)
- Skips external URLs
- Creates backups in `_posts_backup/` before modifying each file

To migrate a single file:

```bash
uv run scripts/migrate_to_lqip.py --dry-run _posts/2025-02-15-film_camera_photos.md
uv run scripts/migrate_to_lqip.py _posts/2025-02-15-film_camera_photos.md
```

## Step 4: Verify Locally

```bash
bundle exec jekyll serve
```

Open `http://localhost:4000` and check image-heavy posts. Verify:

- [ ] LQIP thumbnails load immediately (blurred previews visible)
- [ ] Full images load as you scroll (blur-to-sharp transition)
- [ ] No layout shift — images reserve space via `aspect-ratio`
- [ ] Grid layouts still render correctly
- [ ] Posts without `media_subpath` are unaffected

## Step 5: Clean Up

Once everything is working:

1. **Delete backups**: `rm -rf _posts_backup/`
2. **Reduce GitHub Action schedule**: Change the weekly cron to monthly, or remove the schedule trigger entirely if the Lambda is reliable
3. **Delete this file**: `rm docs/migration.md`
